import os
import base64

import pickle
import json

import openai
from openai import OpenAI
import numpy as np


os.environ["OPENAI_API_KEY"] = "YOUR_API_KEY"
client = OpenAI()

def get_result(prompt, base64_image1, base64_image2):
    while True:
        try:
            response = client.chat.completions.create(
              model="gpt-4o-2024-08-06",
              messages=[
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": prompt,
                        },
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{base64_image1}"
                            },
                        },
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{base64_image2}"
                            },
                        }
                    ],
                }
            ],
            )
        except Exception as e:
            print('Error occurred, retrying. Error type: ', type(e).__name__)
            return ""
        else:
            res_preds = response.choices[0].message.content
            return res_preds

# Function to encode the image
def encode_image(image_path):
    with open(image_path, "rb") as image_file:
        return base64.b64encode(image_file.read()).decode("utf-8")

prompt = """
Please act as an impartial evaluator to assess the quality of concept images generated by two AI concept generators based on the userâ€™s requirements. The evaluation criteria are as follows:
Faithfulness: Evaluate how well the object aligns with the provided instructions, including its intended affordances and functionalities. Does the text and image together indicate that the object serves the purpose for which it was designed? 
Novelty: Assess the originality and innovation of the design. Does the concept demonstrate a surprising or intriguing approach that stands out as fresh and exciting?
Practicality: Evaluate the real-world applicability of the concept. Does the design make sense for human use, align with user preferences, and appear feasible for production?
Coherence: This metric evaluates whether the image generated by the AI model contains only one primary object as instructed, focusing on the object's clarity and functionality without the presence of additional, unintended objects.
Provide your answer based on the follow available choices:
"A" if the first image is better,
"B" if the second image is better,
"C" if both are equally strong.
Your final response should strictly following this format: 
{
    "Faithfulness": [Your Faithfulness Choice],
    "Novelty": [Your Novelty Choice],
    "Practicality": [Your Practicality Choice],
    "Coherence": [Your Coherence Choice]
}
Return the json object only.
"""


image_path = "YOUR GENERATED IMAGE PATH"
test_path = "GROUND TRUTH (SILVER LABELED) IMAGE PATH"
base64_image1 = encode_image(image_path)
base64_image2 = encode_image(test_path)
curr_result = get_result(prompt, base64_image1, base64_image2)
all_results.append(curr_result)
