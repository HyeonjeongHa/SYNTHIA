import os
import base64

import pickle
import json

import openai
from openai import OpenAI
import numpy as np

os.environ["OPENAI_API_KEY"] = "YOUR_API_KEY"

client = OpenAI()

def get_result(prompt, base64_image):
    while True:
        try:
            response = client.chat.completions.create(
              model="gpt-4o-2024-08-06",
              messages=[
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": prompt,
                        },
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{base64_image}"
                            },
                        }
                    ],
                }
            ],
            )
        except Exception as e:
            print('Error occurred, retrying. Error type: ', type(e).__name__)
            return ""
        else:
            res_preds = response.choices[0].message.content
            return res_preds

# Function to encode the image
def encode_image(image_path):
    with open(image_path, "rb") as image_file:
        return base64.b64encode(image_file.read()).decode("utf-8")

prompt = """
Please act as an impartial evaluator to assess the quality of a single concept image generated by an AI, based on the userâ€™s requirements. Your evaluation should use the following three criteria, each scored on a scale of 1 to 5:
Faithfulness: Evaluate how well the object aligns with the provided instructions, including its intended affordances and functionalities. Does the text and image together indicate that the object serves the purpose for which it was designed? 
Scoring:
5: Flawlessly combines all specified functionalities as per the instructions. Text and image work in harmony to demonstrate a well-designed and fully functional object.
4: Fulfills most instructions and intended functionalities, with only minor inconsistencies or missing details. Text and image are mostly aligned.
3: Partially fulfills the instructions. Some functionalities are present but not well-integrated or consistent. There may be a minor mismatch between text and image.
2: Struggles to meet the provided instructions, missing key functionalities or combining them poorly. Text and image may conflict.
1: Does not follow the instructions at all. Functionalities are completely missing, irrelevant, or nonsensical.
Novelty: Assess the originality and innovation of the design. Does the object show an exciting, novel design that would surprise or intrigue users?
Scoring:
5: Highly innovative, unique, and impressive. Inspires curiosity or excitement, making it highly desirable to explore.
4: Contains interesting and novel elements, showing clear creative thought and appeal.
3: Displays moderate novelty, with some unique features but remaining relatively conventional or uninspiring.
2: Shows limited novelty, with minimal creativity and overly simplistic or derivative design.
1: Entirely unoriginal and mundane, lacking any creativity and appearing common or uninspiring.
Practicality: Evaluate the real-world applicability of the object. Does the design make sense for human use? Would it align with human preferences and be feasible for production?
Scoring:
5: Extremely practical and human-centric. Highly functional, aligns perfectly with human preferences, and seamlessly fits into real-world scenarios.
4: Mostly practical and applicable, with minor limitations that could be addressed to improve usability.
3: Somewhat practical but with notable flaws or unrealistic elements that may limit usability in real-world scenarios.
2: Largely impractical, with significant flaws or inconsistencies that make it unlikely to be useful.
1: Entirely impractical and unusable, failing to align with human preferences or real-world feasibility.
Coherence
Definition: This metric evaluates whether the image generated by the AI model contains only one primary object as instructed, focusing on the object's clarity and functionality without the presence of additional, unintended objects.
Scoring:
5: The image perfectly showcases one distinct object that aligns with the described attributes. There are no extraneous objects or elements that distract from the main object.
4: The primary object is clear and mostly isolated, but there may be minor elements in the background or periphery that do not significantly detract from the main object.
3: The main object is present and identifiable, but there are other elements in the image that somewhat distract from its clarity and functionality.
2: The image contains multiple objects where the main object is not clearly dominant or distinguishable from other unnecessary elements.
1: The image primarily features multiple objects, making it difficult to identify the intended single object; the composition is cluttered or entirely irrelevant to the instruction.
Provide a score for each criterion, followed by a concise explanation justifying your ratings. Your final response should strictly following this format: 
{
    "Faithfulness": [Your Faithfulness Score],
    "Novelty": [Your Novelty Score],
    "Practicality": [Your Practicality Score],
    "Coherence": [Your Coherence Score]
}
Return the json object only.
"""

for kk in range(len(test_results_all)):
    test_results = pickle.load(open("GENERATED_IMAGE_PATH", "rb"))

    all_results = []
    for ii in range(len(test_results)):
        image_path = "GENERATED_IMAGE_PATH"
        base64_image = encode_image(image_path)
        curr_result = get_result(prompt, base64_image)
        all_results.append(curr_result)
    with open(output_results_all[kk], "wb") as f:
        pickle.dump(all_results, f)

